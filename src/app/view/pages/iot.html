{% extends "base.html" %}

{% block title %}Painel – Agro Digital{% endblock %}

{% block content %}

<h1>{{ title }}</h1>

<div class="container-flex">
    <button style="background-color: var(--acent)" id="btn-simulate">Gerar leitura</button>

    <table id="iot-table" class="table">
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Umidade (%)</th>
                <th>pH</th>
                <th>Fósforo (P)</th>
                <th>Potássio (K)</th>
                <th>Bomba ligada</th>
            </tr>
        </thead>
        <tbody id="iot-body">
            {# Linhas virão dinamicamente #}
        </tbody>
    </table>
</div>

<script>

const tbody = document.getElementById("iot-body");

document.getElementById("btn-simulate").onclick = () => {
    fetch("/api/iot/simulate", { method: "POST" })
        .then(r => r.json())
        .then(res => {
            if (res.status !== "success") {
                alert("Erro ao simular leitura");
                return;
            }
            addRow(res.data);
        })
        .catch(err => console.error(err));
};

function addRow(data) {
    const tr = document.createElement("tr");
    const original = data.timestamp
    const date = new Date(original)


    const options = {
      timeZone: "America/Sao_Paulo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
};

    const formattedLocal = new Intl.DateTimeFormat("pt-BR", options).format(date);

    tr.innerHTML = `
        <td>${formattedLocal}</td>
        <td>${data.humidity}</td>
        <td>${data.ph}</td>
        <td>${data.phosphorus ? "Sim" : "Não"}</td>
        <td>${data.potassium ? "Sim" : "Não"}</td>
        <td class="${data.pump_on ? "on" : "off"}">
            ${data.pump_on ? "Ligada" : "Desligada"}
        </td>
    `;

    tbody.prepend(tr);
}

document.addEventListener("DOMContentLoaded", function() {
    const url = '/api/iot/readings'

    fetch(url)
        .then(response => {
            return response.json()
        })
        .then(data => {
            for (const row in data) {
                try{
                    addRow(data[row])
                } catch (e) {
                    console.log(e)
                }
            }
        })

})

</script>

{% endblock %}
